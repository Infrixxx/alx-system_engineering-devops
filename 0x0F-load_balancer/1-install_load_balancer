#!/bin/bash

# Check for root privilege
if [[ $EUID -ne 0 ]]; then
    echo "This script must be run as root."
    exit 1
fi

# Update package repositories
apt update

# Install HAProxy
apt install -y haproxy

# Check if haproxy.cfg exists before appending
haproxy_cfg="/etc/haproxy/haproxy.cfg"
if [[ ! -f "$haproxy_cfg" ]]; then
    echo "File $haproxy_cfg does not exist. Creating a new file."
    echo "" | tee "$haproxy_cfg" >/dev/null
fi

# Replace [STUDENT_ID] with your student ID or appropriate identifier
STUDENT_ID="338946"

# Configuration content
server_config="
frontend infrixxx_frontend
    bind *:80
    mode http
    default_backend infrixxx_backend

backend infrixxx_backend
    balance roundrobin
    server web-01 ${STUDENT_ID}-web-01:80 check
    server web-02 ${STUDENT_ID}-web-02:80 check
"

# Append configuration to haproxy.cfg
echo "$server_config" | tee -a "$haproxy_cfg" >/dev/null

# Enable HAProxy to be started by init script
echo "ENABLED=1" | tee -a /etc/default/haproxy >/dev/null

# Test HAProxy configuration
if haproxy -c -f "$haproxy_cfg"; then
    echo "HAProxy configuration test successful."
else
    echo "Error: HAProxy configuration test failed."
    exit 1
fi

# Restart HAProxy service
if systemctl restart haproxy; then
    echo "HAProxy service restarted successfully."
else
    echo "Error: Failed to restart HAProxy service."
    exit 1
fi

exit 0
